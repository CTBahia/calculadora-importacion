<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Importaci√≥n desde China</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè≠ Calculadora de Importaci√≥n desde China</h1>
            <p>Herramienta completa para calcular costos de importaci√≥n y precios de venta</p>
            <div class="header-controls">
                <button class="btn btn-warning" onclick="reiniciarDatos()">üîÑ Reiniciar Todo</button>
                <button class="btn btn-success" onclick="exportarDatos()">üì§ Exportar Datos</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDatos(event)">
                <button class="btn btn-info" onclick="document.getElementById('importFile').click()">üì• Importar Datos</button>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'fabricacion')">üè≠ Fabricaci√≥n China</button>
            <button class="tab" onclick="openTab(event, 'importacion')">üö¢ Importaci√≥n</button>
            <button class="tab" onclick="openTab(event, 'locales')">üì¶ Costos Locales</button>
            <button class="tab" onclick="openTab(event, 'precios')">üí∞ An√°lisis Precios</button>
            <button class="tab" onclick="openTab(event, 'resultados')">üìä Resultados</button>
        </div>
        
        <!-- Pesta√±a 1: Fabricaci√≥n en China -->
        <div id="fabricacion" class="tab-content active">
            <h2 class="section-title">üè≠ Costos de Fabricaci√≥n en China</h2>
            
            <div class="card">
                <h3>üì¶ Productos a Importar</h3>
                <div id="productos-container">
                    <!-- Los productos se agregan din√°micamente -->
                </div>
                <button type="button" class="btn btn-primary" onclick="agregarProducto()">+ Agregar Producto</button>
            </div>
            
            <div class="card">
                <h3>üí± Configuraci√≥n de Divisas</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tipoCambioUSD">Tipo de Cambio USD/CNY</label>
                        <input type="number" id="tipoCambioUSD" value="7.2" step="0.01">
                        <div class="tooltip">Tipo de cambio del d√≥lar a yuan chino</div>
                    </div>
                    <div class="form-group">
                        <label for="tipoCambioEUR">üí∂ Tipo de Cambio USD/EUR</label>
                        <input type="number" id="tipoCambioEUR" value="0.92" step="0.001">
                        <div class="tooltip">Tipo de cambio del d√≥lar a euro (para precios finales)</div>
                    </div>
                    <div class="form-group">
                        <label for="margenProveedor">Margen del Proveedor (%)</label>
                        <input type="number" id="margenProveedor" value="15" step="0.1">
                        <div class="tooltip">Margen adicional que cobra tu proveedor</div>
                    </div>
                    <div class="form-group">
                        <label for="actualizarCambio">Actualizar Cambio Autom√°tico</label>
                        <button type="button" class="btn btn-info" onclick="actualizarTipoCambio()">üîÑ Actualizar EUR/USD</button>
                        <div class="tooltip">Obtener tipo de cambio actual desde internet</div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>üí° Configuraci√≥n de Divisas:</strong><br>
                    ‚Ä¢ Todos los costos se calculan en <strong>USD</strong><br>
                    ‚Ä¢ Los precios finales se muestran en <strong>EUR</strong><br>
                    ‚Ä¢ Tipo de cambio actual: 1 USD = <span id="eurDisplay">0.92</span> EUR
                </div>
            </div>
        </div>
        
        <!-- Pesta√±a 2: Importaci√≥n y Log√≠stica -->
        <div id="importacion" class="tab-content">
            <h2 class="section-title">üö¢ Costos de Importaci√≥n y Log√≠stica</h2>
            
            <div class="card">
                <h3>üåä Env√≠o Internacional (LCL)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="costoEnvioTotal">Costo Total de Env√≠o (USD)</label>
                        <input type="number" id="costoEnvioTotal" value="1500" step="0.01">
                        <div class="tooltip">Costo total del env√≠o mar√≠timo LCL en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="volumenTotal">Volumen Total (m¬≥)</label>
                        <input type="number" id="volumenTotal" value="5" step="0.01">
                        <div class="tooltip">Volumen total del env√≠o en metros c√∫bicos</div>
                    </div>
                    <div class="form-group">
                        <label for="seguroMercancia">Seguro de Mercanc√≠a (%)</label>
                        <input type="number" id="seguroMercancia" value="0.5" step="0.1">
                        <div class="tooltip">Porcentaje del valor CIF para seguro</div>
                    </div>
                    <div class="form-group">
                        <label for="tiempoTransito">Tiempo de Tr√°nsito (d√≠as)</label>
                        <input type="number" id="tiempoTransito" value="35" step="1">
                        <div class="tooltip">D√≠as promedio de China a tu puerto</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üèõÔ∏è Aduanas e Impuestos</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="arancelImportacion">Arancel de Importaci√≥n (%)</label>
                        <input type="number" id="arancelImportacion" value="8" step="0.1">
                        <div class="tooltip">Porcentaje del valor CIF</div>
                    </div>
                    <div class="form-group">
                        <label for="ivaImportacion">IVA Importaci√≥n (%)</label>
                        <input type="number" id="ivaImportacion" value="21" step="0.1">
                        <div class="tooltip">IVA europeo sobre valor CIF + arancel</div>
                    </div>
                    <div class="form-group">
                        <label for="gastosAduanales">Gastos Aduanales Fijos (USD)</label>
                        <input type="number" id="gastosAduanales" value="200" step="0.01">
                        <div class="tooltip">Gastos fijos de despacho aduanal en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="certificaciones">Certificaciones/Inspecciones (USD)</label>
                        <input type="number" id="certificaciones" value="150" step="0.01">
                        <div class="tooltip">CE, certificaciones europeas en USD</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pesta√±a 3: Costos Locales -->
        <div id="locales" class="tab-content">
            <h2 class="section-title">üì¶ Costos Locales y Operativos</h2>
            
            <div class="card">
                <h3>üöõ Transporte y Almacenamiento</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="transporteLocal">Transporte Puerto-Bodega (USD)</label>
                        <input type="number" id="transporteLocal" value="300" step="0.01">
                        <div class="tooltip">Costo de transporte del puerto a tu bodega en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="almacenamientoMensual">Almacenamiento Mensual (USD)</label>
                        <input type="number" id="almacenamientoMensual" value="500" step="0.01">
                        <div class="tooltip">Costo mensual de almacenamiento en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="mesesAlmacenamiento">Meses de Almacenamiento</label>
                        <input type="number" id="mesesAlmacenamiento" value="3" step="0.1">
                        <div class="tooltip">Tiempo promedio de inventario</div>
                    </div>
                    <div class="form-group">
                        <label for="manipulacion">Manipulaci√≥n y Descarga (USD)</label>
                        <input type="number" id="manipulacion" value="200" step="0.01">
                        <div class="tooltip">Costos de descarga y manipulaci√≥n en USD</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üíº Costos Operativos</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="gastosFinancieros">Gastos Financieros (USD)</label>
                        <input type="number" id="gastosFinancieros" value="100" step="0.01">
                        <div class="tooltip">Costos de transferencias, cartas de cr√©dito en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="gastosAdministrativos">Gastos Administrativos (USD)</label>
                        <input type="number" id="gastosAdministrativos" value="200" step="0.01">
                        <div class="tooltip">Gastos administrativos del proceso en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="otrosGastos">Otros Gastos (USD)</label>
                        <input type="number" id="otrosGastos" value="0" step="0.01">
                        <div class="tooltip">Cualquier otro gasto no contemplado en USD</div>
                    </div>
                    <div class="form-group">
                        <label for="merma">Merma/P√©rdidas (%)</label>
                        <input type="number" id="merma" value="2" step="0.1">
                        <div class="tooltip">Porcentaje de productos da√±ados/perdidos</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pesta√±a 4: An√°lisis de Precios -->
        <div id="precios" class="tab-content">
            <h2 class="section-title">üí∞ An√°lisis de Precios de Venta</h2>
            
            <div class="card">
                <h3>üéØ Objetivos de Venta</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="margenObjetivo">Margen de Ganancia Objetivo (%)</label>
                        <input type="number" id="margenObjetivo" value="50" step="1">
                        <div class="tooltip">Margen de ganancia deseado sobre el costo total</div>
                    </div>
                    <div class="form-group">
                        <label for="ventasMensuales">Ventas Mensuales Objetivo (unidades)</label>
                        <input type="number" id="ventasMensuales" value="100" step="1">
                        <div class="tooltip">Unidades que esperas vender por mes</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üõí Costos de Venta Online (en EUR)</h3>
                <div class="alert alert-info">
                    <strong>üí° Nota:</strong> Estos costos se calculan en EUR ya que son gastos locales de venta.
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="comisionPlataforma">Comisi√≥n Plataforma (%)</label>
                        <input type="number" id="comisionPlataforma" value="5" step="0.1">
                        <div class="tooltip">Amazon Europe, eBay, etc.</div>
                    </div>
                    <div class="form-group">
                        <label for="comisionPago">Comisi√≥n de Pago (%)</label>
                        <input type="number" id="comisionPago" value="4" step="0.1">
                        <div class="tooltip">PayPal, Stripe, tarjetas de cr√©dito</div>
                    </div>
                    <div class="form-group">
                        <label for="envioCliente">Env√≠o al Cliente (EUR)</label>
                        <input type="number" id="envioCliente" value="7" step="0.01">
                        <div class="tooltip">Costo promedio de env√≠o al cliente final en EUR</div>
                    </div>
                    <div class="form-group">
                        <label for="empaque">Empaque de Venta (EUR)</label>
                        <input type="number" id="empaque" value="2" step="0.01">
                        <div class="tooltip">Costo de empaque para venta en EUR</div>
                    </div>
                    <div class="form-group">
                        <label for="publicidad">Publicidad por Venta (EUR)</label>
                        <input type="number" id="publicidad" value="8" step="0.01">
                        <div class="tooltip">Costo de adquisici√≥n por cliente (CAC) en EUR</div>
                    </div>
                    <div class="form-group">
                        <label for="devolucion">Tasa de Devoluci√≥n (%)</label>
                        <input type="number" id="devolucion" value="3" step="0.1">
                        <div class="tooltip">Porcentaje de productos devueltos</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pesta√±a 5: Resultados -->
        <div id="resultados" class="tab-content">
            <h2 class="section-title">üìä Resultados y An√°lisis</h2>
            
            <div class="alert alert-info">
                <strong>üí° Resumen:</strong> Todos los costos se calculan en USD y los precios finales se muestran en EUR.
                <br><strong>Tipo de cambio actual:</strong> 1 USD = <span id="eurDisplayResult">0.92</span> EUR
            </div>
            
            <div class="results-grid" id="resultados-generales">
                <!-- Los resultados se generan din√°micamente -->
            </div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>üìà Distribuci√≥n de Costos (USD)</h3>
                    <canvas id="costosChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>üí∞ An√°lisis de M√°rgenes por Producto</h3>
                    <canvas id="margenesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üìã Detalle por Producto</h3>
                <table class="summary-table" id="tabla-resultados">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Costo Total (USD)</th>
                            <th>Costo Total (EUR)</th>
                            <th>Precio Sugerido (EUR)</th>
                            <th>Margen (%)</th>
                            <th>Ganancia/Unidad (EUR)</th>
                            <th>Ingresos Mensuales (EUR)</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let productos = [];
        let costosGlobales = {};
        let resultados = {};
        let charts = {}; // Para almacenar referencias a los gr√°ficos
        
        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosCache();
            if (productos.length === 0) {
                agregarProducto(); // Agregar un producto inicial si no hay datos guardados
            }
            setupEventListeners();
            calcularTodo();
        });
        
        // Sistema de cache/guardado autom√°tico
        function guardarEnCache() {
            const datos = {
                productos: productos,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            // Guardar inputs
            const inputs = document.querySelectorAll('input, select');
            datos.inputs = {};
            inputs.forEach(input => {
                if (input.id) {
                    datos.inputs[input.id] = input.value;
                }
            });
            
            try {
                const datosString = JSON.stringify(datos);
                window.localStorage.setItem('calculadoraImportacion', datosString);
                console.log('Datos guardados autom√°ticamente');
            } catch (error) {
                console.warn('No se pudieron guardar los datos en cache:', error);
            }
        }
        
        function cargarDatosCache() {
            try {
                const datosString = window.localStorage.getItem('calculadoraImportacion');
                if (datosString) {
                    const datos = JSON.parse(datosString);
                    
                    // Cargar productos
                    if (datos.productos && datos.productos.length > 0) {
                        productos = datos.productos;
                        recrearProductosUI();
                    }
                    
                    // Cargar valores de inputs
                    if (datos.inputs) {
                        setTimeout(() => {
                            Object.keys(datos.inputs).forEach(inputId => {
                                const input = document.getElementById(inputId);
                                if (input) {
                                    input.value = datos.inputs[inputId];
                                }
                            });
                            calcularTodo();
                        }, 100);
                    }
                    
                    console.log('Datos cargados desde cache. √öltima actualizaci√≥n:', datos.timestamp);
                }
            } catch (error) {
                console.warn('Error al cargar datos del cache:', error);
            }
        }
        
        function reiniciarDatos() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar todos los datos? Esta acci√≥n no se puede deshacer.')) {
                // Limpiar cache
                window.localStorage.removeItem('calculadoraImportacion');
                
                // Reiniciar variables
                productos = [];
                costosGlobales = {};
                resultados = {};
                
                // Limpiar UI
                document.getElementById('productos-container').innerHTML = '';
                
                // Restaurar valores por defecto
                const defaultValues = {
                    'tipoCambioUSD': 7.2,
                    'tipoCambioEUR': 0.92,
                    'margenProveedor': 15,
                    'costoEnvioTotal': 1500,
                    'volumenTotal': 5,
                    'seguroMercancia': 0.5,
                    'tiempoTransito': 35,
                    'arancelImportacion': 8,
                    'ivaImportacion': 21,
                    'gastosAduanales': 200,
                    'certificaciones': 150,
                    'transporteLocal': 300,
                    'almacenamientoMensual': 500,
                    'mesesAlmacenamiento': 3,
                    'manipulacion': 200,
                    'gastosFinancieros': 100,
                    'gastosAdministrativos': 200,
                    'otrosGastos': 0,
                    'merma': 2,
                    'margenObjetivo': 50,
                    'ventasMensuales': 100,
                    'comisionPlataforma': 5,
                    'comisionPago': 4,
                    'envioCliente': 7,
                    'empaque': 2,
                    'publicidad': 8,
                    'devolucion': 3
                };
                
                Object.keys(defaultValues).forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = defaultValues[id];
                    }
                });
                
                // Agregar producto inicial
                agregarProducto();
                
                // Limpiar gr√°ficos
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                calcularTodo();
                alert('Datos reiniciados correctamente');
            }
        }
        
        // Funci√≥n para actualizar tipo de cambio autom√°ticamente
        async function actualizarTipoCambio() {
            try {
                // Aqu√≠ podr√≠as usar una API real como exchangerate-api.com
                // Por ahora simularemos una actualizaci√≥n
                const respuesta = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const datos = await respuesta.json();
                
                if (datos.rates && datos.rates.EUR) {
                    const tipoCambio = datos.rates.EUR;
                    document.getElementById('tipoCambioEUR').value = tipoCambio.toFixed(3);
                    actualizarDisplayEUR();
                    calcularTodo();
                    alert(`Tipo de cambio actualizado: 1 USD = ${tipoCambio.toFixed(3)} EUR`);
                }
            } catch (error) {
                console.warn('No se pudo actualizar el tipo de cambio:', error);
                alert('No se pudo conectar con el servicio de tipos de cambio. Verifica tu conexi√≥n a internet.');
            }
        }
        
        function actualizarDisplayEUR() {
            const tipoCambio = parseFloat(document.getElementById('tipoCambioEUR')?.value) || 0.92;
            document.getElementById('eurDisplay').textContent = tipoCambio.toFixed(3);
            document.getElementById('eurDisplayResult').textContent = tipoCambio.toFixed(3);
        }
        
        // Exportar/Importar datos
        function exportarDatos() {
            const datos = {
                productos: productos,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            // Incluir todos los inputs
            const inputs = document.querySelectorAll('input, select');
            datos.inputs = {};
            inputs.forEach(input => {
                if (input.id) {
                    datos.inputs[input.id] = input.value;
                }
            });
            
            const datosString = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `calculadora_importacion_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importarDatos(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const datos = JSON.parse(e.target.result);
                        
                        // Cargar productos
                        if (datos.productos) {
                            productos = datos.productos;
                            recrearProductosUI();
                        }
                        
                        // Cargar inputs
                        if (datos.inputs) {
                            Object.keys(datos.inputs).forEach(inputId => {
                                const input = document.getElementById(inputId);
                                if (input) {
                                    input.value = datos.inputs[inputId];
                                }
                            });
                        }
                        
                        calcularTodo();
                        guardarEnCache();
                        alert('Datos importados correctamente');
                    } catch (error) {
                        alert('Error al importar los datos. Verifica que el archivo sea v√°lido.');
                        console.error('Error al importar:', error);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        function recrearProductosUI() {
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            
            productos.forEach((producto, index) => {
                const productoDiv = document.createElement('div');
                productoDiv.className = 'product-row';
                productoDiv.innerHTML = `
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="nombre_${index}" value="${producto.nombre || ''}" placeholder="Ej: Auriculares Bluetooth" onchange="actualizarProducto(${index})">
                    </div>
                    <div class="form-group">
                        <label>Precio FOB (USD)</label>
                        <input type="number" id="precio_${index}" value="${producto.precio || 15}" step="0.01" onchange="actualizarProducto(${index})">
                    </div>
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="cantidad_${index}" value="${producto.cantidad || 100}" step="1" onchange="actualizarProducto(${index})">
                    </div>
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" id="peso_${index}" value="${producto.peso || 0.5}" step="0.01" onchange="actualizarProducto(${index})">
                    </div>
                    <div class="form-group">
                        <label>Volumen (m¬≥)</label>
                        <input type="number" id="volumen_${index}" value="${producto.volumen || 0.1}" step="0.01" onchange="actualizarProducto(${index})">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger" onclick="eliminarProducto(${index})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(productoDiv);
            });
            
            setupEventListeners();
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.removeEventListener('input', handleInputChange); // Evitar duplicados
                input.addEventListener('input', handleInputChange);
            });
        }
        
        function handleInputChange() {
            actualizarDisplayEUR();
            calcularTodo();
            guardarEnCache(); // Guardar autom√°ticamente en cada cambio
        }
        
        // Funci√≥n para cambiar pesta√±as
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            
            const tablinks = document.getElementsByClassName("tab");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            
            if (tabName === 'resultados') {
                calcularTodo();
                setTimeout(mostrarResultados, 100);
            }
        }
        
        // Agregar producto
        function agregarProducto() {
            const container = document.getElementById('productos-container');
            const index = productos.length;
            
            const productoDiv = document.createElement('div');
            productoDiv.className = 'product-row';
            productoDiv.innerHTML = `
                <div class="form-group">
                    <label>Nombre del Producto</label>
                    <input type="text" id="nombre_${index}" placeholder="Ej: Auriculares Bluetooth" onchange="actualizarProducto(${index})">
                </div>
                <div class="form-group">
                    <label>Precio FOB (USD)</label>
                    <input type="number" id="precio_${index}" value="15" step="0.01" onchange="actualizarProducto(${index})">
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="cantidad_${index}" value="100" step="1" onchange="actualizarProducto(${index})">
                </div>
                <div class="form-group">
                    <label>Peso (kg)</label>
                    <input type="number" id="peso_${index}" value="0.5" step="0.01" onchange="actualizarProducto(${index})">
                </div>
                <div class="form-group">
                    <label>Volumen (m¬≥)</label>
                    <input type="number" id="volumen_${index}" value="0.1" step="0.01" onchange="actualizarProducto(${index})">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-danger" onclick="eliminarProducto(${index})">üóëÔ∏è</button>
                </div>
            `;
            
            container.appendChild(productoDiv);
            
            productos.push({
                index: index,
                nombre: '',
                precio: 15,
                cantidad: 100,
                peso: 0.5,
                volumen: 0.1
            });
            
            setupEventListeners();
            guardarEnCache();
        }
        
        // Actualizar producto
        function actualizarProducto(index) {
            if (productos[index]) {
                productos[index].nombre = document.getElementById(`nombre_${index}`).value || `Producto ${index + 1}`;
                productos[index].precio = parseFloat(document.getElementById(`precio_${index}`).value) || 0;
                productos[index].cantidad = parseInt(document.getElementById(`cantidad_${index}`).value) || 0;
                productos[index].peso = parseFloat(document.getElementById(`peso_${index}`).value) || 0;
                productos[index].volumen = parseFloat(document.getElementById(`volumen_${index}`).value) || 0;
                calcularTodo();
                guardarEnCache();
            }
        }
        
        // Eliminar producto
        function eliminarProducto(index) {
            if (productos.length > 1) {
                productos.splice(index, 1);
                const container = document.getElementById('productos-container');
                container.innerHTML = '';
                
                // Recrear todos los productos con nuevos √≠ndices
                const productosTemp = [...productos];
                productos = [];
                productosTemp.forEach((producto, i) => {
                    agregarProducto();
                    document.getElementById(`nombre_${i}`).value = producto.nombre;
                    document.getElementById(`precio_${i}`).value = producto.precio;
                    document.getElementById(`cantidad_${i}`).value = producto.cantidad;
                    document.getElementById(`peso_${i}`).value = producto.peso;
                    document.getElementById(`volumen_${i}`).value = producto.volumen;
                    actualizarProducto(i);
                });
                calcularTodo();
                guardarEnCache();
            }
        }
        
        // Calcular todo
        function calcularTodo() {
            calcularCostosGlobales();
            calcularCostosProductos();
            if (document.getElementById('resultados').classList.contains('active')) {
                mostrarResultados();
            }
        }
        
        // Calcular costos globales
        function calcularCostosGlobales() {
            costosGlobales = {
                // Fabricaci√≥n
                tipoCambioUSD: parseFloat(document.getElementById('tipoCambioUSD')?.value) || 7.2,
                tipoCambioEUR: parseFloat(document.getElementById('tipoCambioEUR')?.value) || 0.92,
                margenProveedor: parseFloat(document.getElementById('margenProveedor')?.value) || 15,
                
                // Importaci√≥n
                costoEnvioTotal: parseFloat(document.getElementById('costoEnvioTotal')?.value) || 1500,
                volumenTotal: parseFloat(document.getElementById('volumenTotal')?.value) || 5,
                seguroMercancia: parseFloat(document.getElementById('seguroMercancia')?.value) || 0.5,
                tiempoTransito: parseFloat(document.getElementById('tiempoTransito')?.value) || 35,
                
                // Aduanas
                arancelImportacion: parseFloat(document.getElementById('arancelImportacion')?.value) || 8,
                ivaImportacion: parseFloat(document.getElementById('ivaImportacion')?.value) || 21,
                gastosAduanales: parseFloat(document.getElementById('gastosAduanales')?.value) || 200,
                certificaciones: parseFloat(document.getElementById('certificaciones')?.value) || 150,
                
                // Locales
                transporteLocal: parseFloat(document.getElementById('transporteLocal')?.value) || 300,
                almacenamientoMensual: parseFloat(document.getElementById('almacenamientoMensual')?.value) || 500,
                mesesAlmacenamiento: parseFloat(document.getElementById('mesesAlmacenamiento')?.value) || 3,
                manipulacion: parseFloat(document.getElementById('manipulacion')?.value) || 200,
                gastosFinancieros: parseFloat(document.getElementById('gastosFinancieros')?.value) || 100,
                gastosAdministrativos: parseFloat(document.getElementById('gastosAdministrativos')?.value) || 200,
                otrosGastos: parseFloat(document.getElementById('otrosGastos')?.value) || 0,
                merma: parseFloat(document.getElementById('merma')?.value) || 2,
                
                // Precios
                margenObjetivo: parseFloat(document.getElementById('margenObjetivo')?.value) || 50,
                ventasMensuales: parseFloat(document.getElementById('ventasMensuales')?.value) || 100,
                comisionPlataforma: parseFloat(document.getElementById('comisionPlataforma')?.value) || 5,
                comisionPago: parseFloat(document.getElementById('comisionPago')?.value) || 4,
                envioCliente: parseFloat(document.getElementById('envioCliente')?.value) || 7,
                empaque: parseFloat(document.getElementById('empaque')?.value) || 2,
                publicidad: parseFloat(document.getElementById('publicidad')?.value) || 8,
                devolucion: parseFloat(document.getElementById('devolucion')?.value) || 3
            };
        }
        
        // Calcular costos por producto
        function calcularCostosProductos() {
            resultados = {};
            
            productos.forEach((producto, index) => {
                if (producto.cantidad > 0) {
                    const resultado = calcularProducto(producto, index);
                    resultados[index] = resultado;
                }
            });
        }
        
        // Calcular costos de un producto espec√≠fico
        function calcularProducto(producto, index) {
            const costos = {};
            
            // 1. Costo FOB en USD
            costos.fob = producto.precio * producto.cantidad;
            
            // 2. Costo CIF (FOB + Flete + Seguro)
            const proporcionVolumen = producto.volumen / costosGlobales.volumenTotal;
            costos.flete = costosGlobales.costoEnvioTotal * proporcionVolumen;
            costos.seguro = (costos.fob + costos.flete) * (costosGlobales.seguroMercancia / 100);
            costos.cif = costos.fob + costos.flete + costos.seguro;
            
            // 3. Impuestos y aranceles
            costos.arancel = costos.cif * (costosGlobales.arancelImportacion / 100);
            costos.iva = (costos.cif + costos.arancel) * (costosGlobales.ivaImportacion / 100);
            
            // 4. Gastos fijos distribuidos
            const totalUnidades = productos.reduce((sum, p) => sum + p.cantidad, 0);
            const proporcionUnidades = producto.cantidad / totalUnidades;
            
            costos.gastosAduanales = costosGlobales.gastosAduanales * proporcionUnidades;
            costos.certificaciones = costosGlobales.certificaciones * proporcionUnidades;
            costos.transporteLocal = costosGlobales.transporteLocal * proporcionUnidades;
            costos.manipulacion = costosGlobales.manipulacion * proporcionUnidades;
            costos.gastosFinancieros = costosGlobales.gastosFinancieros * proporcionUnidades;
            costos.gastosAdministrativos = costosGlobales.gastosAdministrativos * proporcionUnidades;
            costos.otrosGastos = costosGlobales.otrosGastos * proporcionUnidades;
            
            // 5. Almacenamiento
            costos.almacenamiento = (costosGlobales.almacenamientoMensual * costosGlobales.mesesAlmacenamiento) * proporcionUnidades;
            
            // 6. Costo total de importaci√≥n (en USD)
            costos.totalImportacion = costos.cif + costos.arancel + costos.iva + 
                                    costos.gastosAduanales + costos.certificaciones + 
                                    costos.transporteLocal + costos.manipulacion + 
                                    costos.gastosFinancieros + costos.gastosAdministrativos + 
                                    costos.otrosGastos + costos.almacenamiento;
            
            // 7. Costo por unidad (en USD)
            costos.costoUnitarioUSD = costos.totalImportacion / producto.cantidad;
            
            // 8. Ajuste por merma
            const unidadesEfectivas = producto.cantidad * (1 - costosGlobales.merma / 100);
            costos.costoUnitarioConMermaUSD = costos.totalImportacion / unidadesEfectivas;
            
            // 9. Conversi√≥n a EUR
            costos.costoUnitarioEUR = costos.costoUnitarioConMermaUSD * costosGlobales.tipoCambioEUR;
            
            // 10. Costos de venta (ya en EUR)
            costos.envioClienteEUR = costosGlobales.envioCliente;
            costos.empaqueEUR = costosGlobales.empaque;
            costos.publicidadEUR = costosGlobales.publicidad;
            
            // 11. Costo total por unidad en EUR
            costos.costoTotalUnitarioEUR = costos.costoUnitarioEUR + costos.envioClienteEUR + 
                                         costos.empaqueEUR + costos.publicidadEUR;
            
            // 12. Precio de venta en EUR
            let precioVentaEUR = costos.costoTotalUnitarioEUR / (1 - costosGlobales.margenObjetivo / 100);
            
            // Ajustar por comisiones
            const comisionTotal = costosGlobales.comisionPlataforma + costosGlobales.comisionPago + costosGlobales.devolucion;
            precioVentaEUR = precioVentaEUR / (1 - comisionTotal / 100);
            
            costos.precioVentaEUR = precioVentaEUR;
            costos.comisionesEUR = precioVentaEUR * (comisionTotal / 100);
            
            // 13. An√°lisis de rentabilidad en EUR
            costos.ingresoNetoEUR = precioVentaEUR - costos.comisionesEUR;
            costos.gananciaUnitariaEUR = costos.ingresoNetoEUR - costos.costoTotalUnitarioEUR;
            costos.margenReal = (costos.gananciaUnitariaEUR / costos.ingresoNetoEUR) * 100;
            costos.roi = (costos.gananciaUnitariaEUR / costos.costoTotalUnitarioEUR) * 100;
            
            // 14. Proyecciones mensuales en EUR
            costos.ventasMensuales = costosGlobales.ventasMensuales;
            costos.ingresosMensualesEUR = costos.ingresoNetoEUR * costos.ventasMensuales;
            costos.gananciasMensualesEUR = costos.gananciaUnitariaEUR * costos.ventasMensuales;
            
            return {
                producto: producto,
                costos: costos
            };
        }
        
        // Mostrar resultados
        function mostrarResultados() {
            mostrarResultadosGenerales();
            mostrarTablaDetallada();
            mostrarGraficos();
        }
        
        // Mostrar resultados generales
        function mostrarResultadosGenerales() {
            const container = document.getElementById('resultados-generales');
            
            // Calcular totales
            let totalInversionUSD = 0;
            let totalIngresosMensualesEUR = 0;
            let totalGananciasMensualesEUR = 0;
            let promedioMargen = 0;
            let cantidadProductos = 0;
            
            Object.values(resultados).forEach(resultado => {
                totalInversionUSD += resultado.costos.totalImportacion;
                totalIngresosMensualesEUR += resultado.costos.ingresosMensualesEUR;
                totalGananciasMensualesEUR += resultado.costos.gananciasMensualesEUR;
                promedioMargen += resultado.costos.margenReal;
                cantidadProductos++;
            });
            
            promedioMargen = cantidadProductos > 0 ? promedioMargen / cantidadProductos : 0;
            const totalInversionEUR = totalInversionUSD * costosGlobales.tipoCambioEUR;
            
            container.innerHTML = `
                <div class="result-card">
                    <h4>üí∞ Inversi√≥n Total</h4>
                    <div class="value">${formatCurrency(totalInversionEUR, 'EUR')}</div>
                    <div class="subtitle">${formatCurrency(totalInversionUSD, 'USD')}</div>
                </div>
                <div class="result-card">
                    <h4>üìà Ingresos Mensuales</h4>
                    <div class="value">${formatCurrency(totalIngresosMensualesEUR, 'EUR')}</div>
                    <div class="subtitle">Proyecci√≥n de ventas</div>
                </div>
                <div class="result-card">
                    <h4>üéØ Ganancia Mensual</h4>
                    <div class="value">${formatCurrency(totalGananciasMensualesEUR, 'EUR')}</div>
                    <div class="subtitle">Ganancia neta proyectada</div>
                </div>
                <div class="result-card">
                    <h4>üìä Margen Promedio</h4>
                    <div class="value">${promedioMargen.toFixed(1)}%</div>
                    <div class="subtitle">Margen de ganancia</div>
                </div>
                <div class="result-card">
                    <h4>‚è±Ô∏è ROI Mensual</h4>
                    <div class="value">${((totalGananciasMensualesEUR / totalInversionEUR) * 100).toFixed(1)}%</div>
                    <div class="subtitle">Retorno de inversi√≥n</div>
                </div>
                <div class="result-card">
                    <h4>üì¶ Productos</h4>
                    <div class="value">${cantidadProductos}</div>
                    <div class="subtitle">Productos analizados</div>
                </div>
            `;
        }
        
        // Mostrar tabla detallada
        function mostrarTablaDetallada() {
            const tbody = document.getElementById('tabla-body');
            let html = '';
            
            Object.values(resultados).forEach(resultado => {
                const { producto, costos } = resultado;
                html += `
                    <tr>
                        <td><strong>${producto.nombre || 'Producto ' + (producto.index + 1)}</strong></td>
                        <td>${formatCurrency(costos.costoTotalUnitarioEUR / costosGlobales.tipoCambioEUR, 'USD')}</td>
                        <td>${formatCurrency(costos.costoTotalUnitarioEUR, 'EUR')}</td>
                        <td>${formatCurrency(costos.precioVentaEUR, 'EUR')}</td>
                        <td>${costos.margenReal.toFixed(1)}%</td>
                        <td>${formatCurrency(costos.gananciaUnitariaEUR, 'EUR')}</td>
                        <td>${formatCurrency(costos.ingresosMensualesEUR, 'EUR')}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Mostrar gr√°ficos
        function mostrarGraficos() {
            mostrarGraficoCostos();
            mostrarGraficoMargenes();
        }
        
        // Gr√°fico de distribuci√≥n de costos
        function mostrarGraficoCostos() {
            const ctx = document.getElementById('costosChart').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (charts.costos) {
                charts.costos.destroy();
            }
            
            // Calcular costos promedio
            let totalFOB = 0, totalFlete = 0, totalImpuestos = 0, totalGastos = 0, totalLocales = 0;
            let count = 0;
            
            Object.values(resultados).forEach(resultado => {
                const c = resultado.costos;
                totalFOB += c.fob / resultado.producto.cantidad;
                totalFlete += (c.flete + c.seguro) / resultado.producto.cantidad;
                totalImpuestos += (c.arancel + c.iva) / resultado.producto.cantidad;
                totalGastos += (c.gastosAduanales + c.certificaciones + c.gastosFinancieros + c.gastosAdministrativos) / resultado.producto.cantidad;
                totalLocales += (c.transporteLocal + c.manipulacion + c.almacenamiento) / resultado.producto.cantidad;
                count++;
            });
            
            if (count === 0) return;
            
            charts.costos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Producto FOB', 'Flete y Seguro', 'Impuestos y Aranceles', 'Gastos Aduanales', 'Costos Locales'],
                    datasets: [{
                        data: [
                            totalFOB / count,
                            totalFlete / count,
                            totalImpuestos / count,
                            totalGastos / count,
                            totalLocales / count
                        ],
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#f39c12',
                            '#9b59b6',
                            '#27ae60'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': 
                 + context.parsed.toFixed(2) + ' USD';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Gr√°fico de m√°rgenes por producto
        function mostrarGraficoMargenes() {
            const ctx = document.getElementById('margenesChart').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (charts.margenes) {
                charts.margenes.destroy();
            }
            
            const labels = [];
            const margenes = [];
            const ganancias = [];
            
            Object.values(resultados).forEach(resultado => {
                labels.push(resultado.producto.nombre || `Producto ${resultado.producto.index + 1}`);
                margenes.push(resultado.costos.margenReal);
                ganancias.push(resultado.costos.gananciaUnitariaEUR);
            });
            
            charts.margenes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Margen (%)',
                        data: margenes,
                        backgroundColor: '#3498db',
                        yAxisID: 'y'
                    }, {
                        label: 'Ganancia (EUR)',
                        data: ganancias,
                        backgroundColor: '#27ae60',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Margen (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Ganancia (EUR)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // Formatear moneda
        function formatCurrency(amount, currency = 'EUR') {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2
            }).format(amount);
        }
    </script>
</body>
</html>